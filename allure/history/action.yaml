name: 'Report generating'
description: 'All required steps after tests'
inputs:
  aws-access-key-id:
    required: true
    description: AWS access key id
  aws-secret-access-key:
    required: true
    description: AWS secret access key
  aws-http-proxy:
    required: true
    description: AWS http proxy
  aws-https-proxy:
    required: true
    description: AWS https proxy
  environment:
    required: true
    description: Environment name
  enable-history:
    required: true
    default: 'false'
    description: Enable history
  retention:
    required: false
    default: '30days'
    description: Test report storage folder
  team:
    required: true
    description: Team name
  path_to_artifacts:
    required: false
    default: 'artifacts/'
    description: 'Path to parent artifacts directory containing allure/ folder'
  matrix_block:
    required: false
    description: 'Optional field if someone uses a matrix in the repository'


runs:
  using: "composite"
  steps:

    - name: Set constants
      shell: bash
      run: |
        echo "S3_BUCKET=piwikpro-artifactory" >> $GITHUB_ENV
   
    - name: Set history path
      shell: bash
      run: |
        # Sanitize matrix_block for S3 history path
        MATRIX_BLOCK_RAW="${{ inputs.matrix_block }}"
        MATRIX_BLOCK_SANITIZED="${MATRIX_BLOCK_RAW// /_}"
        
        # Build S3 history path conditionally
        if [ -n "${MATRIX_BLOCK_SANITIZED}" ]; then
          S3_HISTORY_PATH="${{ inputs.retention }}/${{ inputs.team }}/tests/history/${{ github.workflow_ref }}/${{ inputs.environment }}/${MATRIX_BLOCK_SANITIZED}"
        else
          S3_HISTORY_PATH="${{ inputs.retention }}/${{ inputs.team }}/tests/history/${{ github.workflow_ref }}/${{ inputs.environment }}"
        fi
        
        echo "S3_HISTORY_PATH=${S3_HISTORY_PATH}" >> $GITHUB_ENV
      
    - name: Download Allure history from S3 before generating report
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_DEFAULT_REGION: eu-central-1
        HTTP_PROXY: ${{ inputs.aws-http-proxy }}
        HTTPS_PROXY: ${{ inputs.aws-https-proxy }}
      run: |
        # Remove trailing slash from path
        ARTIFACTS_PARENT="${{ inputs.path_to_artifacts }}"
        ARTIFACTS_PARENT="${ARTIFACTS_PARENT%/}"
        
        TARGET_USER=${SUDO_USER:-$(id -un)}
        TARGET_GROUP=$(id -gn "$TARGET_USER")
        # Create history directory inside allure folder
        ALLURE_REPORT_HISTORY_DIR="${ARTIFACTS_PARENT}/allure/history"
        sudo mkdir -p "${ALLURE_REPORT_HISTORY_DIR}"
        sudo chown -R "$TARGET_USER:$TARGET_GROUP" "${ARTIFACTS_PARENT}/allure"
        
        # Download all history from S3
        echo "Downloading all history for environment: ${{ inputs.environment }}"
        aws s3 sync s3://${{ env.S3_BUCKET }}/${{ env.S3_HISTORY_PATH }}/ "${ALLURE_REPORT_HISTORY_DIR}/" || echo "No previous history found"
        
        # Verify history was downloaded
        if [ -d "${ALLURE_REPORT_HISTORY_DIR}" ] && [ "$(ls -A ${ALLURE_REPORT_HISTORY_DIR})" ]; then
          HISTORY_COUNT=$(find "${ALLURE_REPORT_HISTORY_DIR}" -type f 2>/dev/null | wc -l)
          echo "Downloaded $HISTORY_COUNT history files"
          echo "History downloaded successfully"
        else
          echo "No history found - this will be the first run"
        fi

    - name: Generate allure report
      uses: PiwikPRO/actions/allure/report@uzi-allure
      with:
        path_to_artifacts: ${{ inputs.path_to_artifacts }}

    - name: Upload HTML report to S3
      uses: PiwikPRO/actions/s3/upload@master
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-http-proxy: ${{ inputs.aws-http-proxy }}
        aws-https-proxy: ${{ inputs.aws-https-proxy }}
        aws-bucket: ${{ env.S3_BUCKET }}
        aws-region: eu-central-1
        src-path: ${{ inputs.path_to_artifacts }}
        dst-path: ${{ env.S3_PATH }}

    - name: Upload new Allure history to S3
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_DEFAULT_REGION: eu-central-1
        HTTP_PROXY: ${{ inputs.aws-http-proxy }}
        HTTPS_PROXY: ${{ inputs.aws-https-proxy }}
      run: |
        # Remove trailing slash from path
        ARTIFACTS_PARENT="${{ inputs.path_to_artifacts }}"
        ARTIFACTS_PARENT="${ARTIFACTS_PARENT%/}"
        
        # Upload new history to S3
        # Note: All history is kept in S3 and all history is downloaded for display
        ALLURE_GENERATED_HISTORY_DIR="${ARTIFACTS_PARENT}/allure-report/history"
        echo "Uploading new history for environment: ${{ github.workflow_ref }}/${{ inputs.environment }}"
        aws s3 sync "${ALLURE_GENERATED_HISTORY_DIR}/" s3://${{ env.S3_BUCKET }}/${{ env.S3_HISTORY_PATH }}/ || echo "Failed to upload history"
        
        echo "History uploaded successfully. All history is preserved in S3."

    - name: Generate summary
      shell: bash
      run: |
        echo "[Allure Report](${{ env.ALLURE_REPORT_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "Branch: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ALLURE_REPORT_URL=${{ env.ALLURE_REPORT_URL }}" >> $GITHUB_ENV