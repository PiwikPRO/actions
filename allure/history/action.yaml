name: 'Report generating'
description: 'All required steps after tests'
inputs:
  aws-access-key-id:
    required: true
    description: AWS access key id
  aws-secret-access-key:
    required: true
    description: AWS secret access key
  aws-http-proxy:
    required: true
    description: AWS http proxy
  aws-https-proxy:
    required: true
    description: AWS https proxy
  environment:
    required: true
    description: Environment name
  enable-history:
    required: true
    default: 'false'
    description: Enable history
  retention:
    required: false
    default: '30days'
    description: Test report storage folder
  team:
    required: true
    description: Team name
  path-to-artifacts:
    required: false
    default: artifacts/
    description: Path to artifacts directory

runs:
  using: "composite"
  steps:

    - name: Set constants
      shell: bash
      run: |
        echo "S3_BUCKET=piwikpro-artifactory" >> $GITHUB_ENV
        echo "S3_HISTORY_PATH=${{ inputs.retention }}/${{ inputs.team }}/tests/history/${{ github.workflow_ref }}/${{ github.head_ref || github.ref_name }}/${{ inputs.environment }}" >> $GITHUB_ENV

    - name: Download Allure history from S3 before generating report
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_DEFAULT_REGION: eu-central-1
        HTTP_PROXY: ${{ inputs.aws-http-proxy }}
        HTTPS_PROXY: ${{ inputs.aws-https-proxy }}
      run: |
        # Create history directory
        mkdir -p artifacts/allure/history/
        
        # Download all history from S3
        echo "Downloading all history for environment: ${{ inputs.environment }}"
        aws s3 sync s3://${{ env.S3_BUCKET }}/${{ env.S3_HISTORY_PATH }}/ artifacts/allure/history/ || echo "No previous history found"
        
        # Verify history was downloaded
        if [ -d "artifacts/allure/history" ] && [ "$(ls -A artifacts/allure/history)" ]; then
          HISTORY_COUNT=$(find artifacts/allure/history -type f 2>/dev/null | wc -l)
          echo "Downloaded $HISTORY_COUNT history files"
          echo "History downloaded successfully"
        else
          echo "No history found - this will be the first run"
        fi

    - name: Generate allure report
      uses: PiwikPRO/actions/allure/report@master

    - name: Upload HTML report to S3
      uses: PiwikPRO/actions/s3/upload@master
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-http-proxy: ${{ inputs.aws-http-proxy }}
        aws-https-proxy: ${{ inputs.aws-https-proxy }}
        aws-bucket: ${{ env.S3_BUCKET }}
        aws-region: eu-central-1
        src-path: ${{ inputs.path-to-artifacts }}
        dst-path: ${{ env.S3_PATH }}

    - name: Upload new Allure history to S3
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_DEFAULT_REGION: eu-central-1
        HTTP_PROXY: ${{ inputs.aws-http-proxy }}
        HTTPS_PROXY: ${{ inputs.aws-https-proxy }}
      run: |
        # Upload new history to S3
        # Note: All history is kept in S3 and all history is downloaded for display
        echo "Uploading new history for environment: ${{ github.workflow_ref }}/${{ inputs.environment }}"
        aws s3 sync artifacts/allure-report/history/ s3://${{ env.S3_BUCKET }}/${{ env.S3_HISTORY_PATH }}/ || echo "Failed to upload history"
        
        echo "History uploaded successfully. All history is preserved in S3."

    - name: Generate summary
      shell: bash
      run: |
        echo "[Allure Report](${{ env.ALLURE_REPORT_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "Branch: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ALLURE_REPORT_URL=${{ env.ALLURE_REPORT_URL }}" >> $GITHUB_ENV