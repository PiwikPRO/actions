name: 'Report generating'
description: 'All required steps after tests'
inputs:
  aws-access-key-id:
    required: true
    description: AWS access key id
  aws-secret-access-key:
    required: true
    description: AWS secret access key
  aws-http-proxy:
    required: true
    description: AWS http proxy
  aws-https-proxy:
    required: true
    description: AWS https proxy
  environment:
    required: true
    description: Environment name
  enable-history:
    required: true
    default: 'false'
    description: Enable history
  retention:
    required: false
    default: '30days'
    description: Test report storage folder
  team:
    required: true
    description: Team name
  path_to_artifacts:
    required: false
    default: 'artifacts/'
    description: 'Path to parent artifacts directory containing allure/ folder'
  matrix_block:
    required: false
    description: 'Optional field if someone uses a matrix in the repository'


runs:
  using: "composite"
  steps:

    - name: Set environment variables
      shell: bash
      run: |
        MATRIX_BLOCK="${{ inputs.matrix_block }}"
        MATRIX_BLOCK="${MATRIX_BLOCK// /_}"
        MATRIX_SUFFIX="${MATRIX_BLOCK:+/${MATRIX_BLOCK}}"

        echo "S3_BUCKET=piwikpro-artifactory" >> $GITHUB_ENV
        echo "S3_HISTORY_PATH=${{ inputs.retention }}/${{ inputs.team }}/tests/history/${{ github.workflow_ref }}/${{ inputs.environment }}${MATRIX_SUFFIX}" >> $GITHUB_ENV

    - name: Prepare history directory
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      shell: bash
      run: |
        ARTIFACTS_PARENT="${{ inputs.path_to_artifacts }}"
        ARTIFACTS_PARENT="${ARTIFACTS_PARENT%/}"

        TARGET_USER=${SUDO_USER:-$(id -un)}
        TARGET_GROUP=$(id -gn "$TARGET_USER")
        ALLURE_REPORT_HISTORY_DIR="${ARTIFACTS_PARENT}/allure/history"
        sudo mkdir -p "${ALLURE_REPORT_HISTORY_DIR}"
        sudo chown -R "$TARGET_USER:$TARGET_GROUP" "${ARTIFACTS_PARENT}/allure"

    - name: Download Allure history from S3 before generating report
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      uses: PiwikPRO/actions/s3/download@MID-6856-update-allure-action-test
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-bucket: ${{ env.S3_BUCKET }}
        aws-region: eu-central-1
        aws-http-proxy: ${{ inputs.aws-http-proxy }}
        aws-https-proxy: ${{ inputs.aws-https-proxy }}
        src-path: ${{ env.S3_HISTORY_PATH }}/
        dst-path: ${{ inputs.path_to_artifacts }}allure/history/
        ignore-missing: 'false'

    - name: Generate allure report
      uses: PiwikPRO/actions/allure/report@MID-6856-update-allure-action-test
      with:
        path_to_artifacts: ${{ inputs.path_to_artifacts }}

    - name: Upload HTML report to S3
      uses: PiwikPRO/actions/s3/upload@MID-6856-update-allure-action-test
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-http-proxy: ${{ inputs.aws-http-proxy }}
        aws-https-proxy: ${{ inputs.aws-https-proxy }}
        aws-bucket: ${{ env.S3_BUCKET }}
        aws-region: eu-central-1
        src-path: ${{ inputs.path_to_artifacts }}
        dst-path: ${{ env.S3_PATH }}

    - name: Upload new Allure history to S3
      if: ${{ inputs.enable-history == 'true' && !cancelled() }}
      uses: PiwikPRO/actions/s3/upload@MID-6856-update-allure-action-test
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-bucket: ${{ env.S3_BUCKET }}
        aws-region: eu-central-1
        aws-http-proxy: ${{ inputs.aws-http-proxy }}
        aws-https-proxy: ${{ inputs.aws-https-proxy }}
        src-path: ${{ inputs.path_to_artifacts }}allure-report/history/
        dst-path: ${{ env.S3_HISTORY_PATH }}/
        echo-destination-index-html: 'false'

    - name: Generate summary
      shell: bash
      run: |
        echo "[Allure Report](${{ env.ALLURE_REPORT_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "Branch: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ALLURE_REPORT_URL=${{ env.ALLURE_REPORT_URL }}" >> $GITHUB_ENV